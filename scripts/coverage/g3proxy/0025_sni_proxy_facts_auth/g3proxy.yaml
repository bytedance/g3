---

log: journal

stat:
  target:
    udp: 127.0.0.1:8125

resolver:
  - name: default
    type: c-ares
    server:
      - 127.0.0.1

escaper:
  - name: default
    type: direct_fixed
    resolver: default
    egress_net_filter:
      default: allow
      allow: 127.0.0.1

user_group:
  - name: match_by_facts
    type: facts
    static_users:
      - name: t1
        match_by_facts:
          - ip: 127.0.0.1
          - ip: "::1"
          - domain: httpbin.local
        tcp_sock_speed_limit: 10M
        tcp_all_upload_speed_limit: 20M
        tcp_all_download_speed_limit: 50M
        tcp_conn_rate_limit: 100
        request_rate_limit: 500
        request_max_alive: 10000

server:
  - name: http
    type: http_rproxy
    listen: 127.0.0.1:8080
    escaper: default
    hosts:
      - exact_match: httpbin.local
        upstream: 127.0.0.1:9443
        tls_client:
          ca_certificate: ../rootCA.pem
        tls_name: httpbin.local
  - name: tls8443
    type: tls_stream
    escaper: default
    listen: 127.0.0.1:8443
    tls_server:
      cert_pairs:
        certificate: ../httpbin.local.pem
        private-key: ../httpbin.local-key.pem
    upstream: 127.0.0.1:9443
    tls_client:
      ca_certificate: ../rootCA.pem
    upstream_tls_name: httpbin.local
  - name: tls
    type: tls_stream
    escaper: default
    listen: 127.0.0.1:9443
    tls_server:
      cert_pairs:
        certificate: ../httpbin.local.pem
        private-key: ../httpbin.local-key.pem
    upstream: 127.0.0.1:80
  - name: sni8443
    escaper: default
    type: sni_proxy
    user_group: match_by_facts
    auth_by_server_name: true
    listen: "[::1]:8443"
    flush_task_log_on_created: true
    flush_task_log_on_connected: true
    task_log_flush_interval: 10s
  - name: sni8080
    escaper: default
    type: sni_proxy
    user_group: match_by_facts
    auth_by_client_ip: true
    listen: "[::1]:8080"
